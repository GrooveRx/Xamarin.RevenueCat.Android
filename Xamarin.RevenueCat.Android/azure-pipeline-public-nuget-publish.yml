pool:
  vmImage: 'macOS-10.15'

steps:
- bash: |
    echo "##vso[task.setvariable variable=bindingsVersion]$(cat ./Xamarin.RevenueCat.Android/Xamarin.RevenueCat.Android.csproj | grep "<Version>" | awk -F '[<>]' '{print $3}')"

- bash: |
    echo "##vso[build.updatebuildnumber]xamarin-revenuecat-android-$(bindingsVersion)-$(Build.BuildId)"

- bash: |
    git checkout $(Build.SourceBranchName)
    git tag release-v$(bindingsVersion)
    git push release-v$(bindingsVersion)

- task: MSBuild@1
  inputs:
    solution: 'Xamarin.RevenueCat.Android/Xamarin.RevenueCat.Android.csproj'
    msbuildVersion: '16.0'
    msbuildArchitecture: 'x64'
    configuration: 'Release'

- task: NuGetAuthenticate@0
  inputs:
    nuGetServiceConnections: 'nuget.org thisisthekap connection'

- task: NuGetCommand@2
  inputs:
    command: 'push'
    packagesToPush: 'Xamarin.RevenueCat.Android/nugetoutput/*.nupkg;!Xamarin.RevenueCat.Android/nugetoutput/*.symbols.nupkg'
    nuGetFeedType: 'external'
    publishFeedCredentials: 'nuget.org thisisthekap connection'

- task: GitHubRelease@1
  inputs:
    gitHubConnection: 'github.com_thisisthekap'
    repositoryName: 'thisisthekap/Xamarin.RevenueCat.Android'
    action: 'create'
    target: '$(Build.SourceVersion)'
    tagSource: 'userSpecifiedTag'
    tag: 'release-v$(bindingsVersion)'
    title: 'Xamarin.RevenueCat.Android $(bindingsVersion)'
    assets: 'Xamarin.RevenueCat.Android/nugetoutput/*.nupkg'
    changeLogCompareToRelease: 'lastFullRelease'
    changeLogType: 'issueBased'
